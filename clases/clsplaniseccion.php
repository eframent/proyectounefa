<?php
   /*
   *      clsInscripcion.php
   *      
   *      Copyright 2012 José Baldomero Silva Hernández <jobasiher@cantv.net>
   *      
   *      Este programa es software libre, puede redistribuirlo y / o modificar
   *      Bajo los términos de la GNU Licensia Pública General(GPL) publicada por
   *      La Fundación de Software Libre(FSF), bien de la versión 2 o cualquier versión posterior.
   *      
   *      Este programa se distribuye con la esperanza de que sea útil,
   *      Pero SIN NINGUNA GARANTÍA, incluso sin la garantía implícita de
   *      COMERCIALIZACIÓN o IDONEIDAD PARA UN PROPÓSITO PARTICULAR.
   */
    session_start();
	require_once("../clases/cls_Seccion.php");
	class clsplaniseccion extends cls_Bitacora
	{
		private $aiNumero;	
		private $asfechapla;
		private $ashorapla;
		private $asperaca;	
		private $ascodesp;
		private $assemestre;
		private $asseccion;
		private $asregimen;
		private $aaDetalle;
   	    private $aiFilas;
   	    private $aiContador;
		
		public function __construct()
		{
			$this->aiNumero=0;
			$this->asfechapla="";
			$this->ashorapla="";  
			$this->asperaca="";
			$this->ascodesp="";
			$this->assemestre="";  
			$this->asseccion=""; 
            $this->asregimen="";
			$this->aiFilas=10;   
		    $this->aiContador=0;
		    $this->aaDetalle=array();
		}
		
		public function __destruct()
		{
		}
		     //*******SET**************
		public function fSetiNumero($piNumero)
		{
			$this->aiNumero=$piNumero;
		}
		
		public function fSetsfechapla($psfechapla)
		{
			$this->asfechapla=$psfechapla;
		}
		
		public function fSetshorapla($pshorapla)
		{
			$this->ashorapla=$pshorapla;
		}
    
    public function fSetsperaca($psperaca)
		{
			$this->asperaca=$psperaca;
		}
    
		public function fSetscodesp($pscodesp)
		{
			$this->ascodesp=$pscodesp;
		}
    
		public function fSetssemestre($pssemestre)
		{
			$this->assemestre=$pssemestre;
		}
		
		public function fSetsseccion($psseccion)
		{
			$this->asseccion=$psseccion;
		}
    	
		public function fSetsregimen($psregimen)
		{
			$this->asregimen=$psregimen;
		}
    
		public function fSetaDetalle($paDetalle)
	    {
		   $this->aaDetalle=$paDetalle;
	    }
	    
      //*******GET**************
		public function fGetiNumero()
		{
			return $this->aiNumero;
		}
		
		public function fGetsfechapla()
		{
			return $this->asfechapla;
		}
		
		public function fGetshorapla()
		{
			return $this->ashorapla;
		}
    
		public function fGetsperaca()
		{
			return $this->asperaca;
		}
		
		public function fGetscodesp()
		{
			return $this->ascodesp;
		}
		
		public function fGetssemestre()
		{
			return $this->assemestre;
		}
		
		public function fGetsseccion()
		{
			return $this->asseccion;
		}
		
		public function fGetsregimen()
		{
			return $this->asregimen;
		}
		
		public function fGetaDetalle()
	    {
	  	   return $this->aaDetalle;
	    }
	    
	    public function fGetiFilas()
		{
			return $this->aiFilas;
		}
	    
		public function fBuscar()
		{
			$lbEnc=false;
			$lsSql="select * from planificacion_sec where(idplanificacion=$this->aiNumero)";
			$this->f_Con();
			$lrTb=$this->f_Filtro($lsSql);
			if($laRow=$this->f_Arreglo($lrTb))
			{
				$this->aiNumero=$laRow["idplanificacion"];
				$this->asfechapla=$laRow["fechapla"];
				$this->ashorapla=$laRow["horapla"];
                $this->asperaca=$laRow["peraca"];
                $this->ascodesp=$laRow["codesp"];
				$this->assemestre=$laRow["semestre"];
				$this->asseccion=$laRow["seccion"];
				$this->asregimen=$laRow["regimen"];
				$lbEnc=true;
			}
       /*
			$this->f_Cierra($lrTb);
			$this->f_Des();
			$lobjEstudiante=new clsEstudiante();
			$lobjEstudiante->fSetsCedula($this->asCedula);
			$lbEnc2=$lobjEstudiante->fBuscar();
			if ($lbEnc2)
		    {
			   $this->asNombre=$lobjEstudiante->fGetsNombre1();
			   $this->asApellido=$lobjEstudiante->fGetsApellido1();
		    } */
		    $lsSql="select * from detalle_plani where (idplanificacion=$this->aiNumero)";
		    $this->f_Con();
			$lrTb=$this->f_Filtro($lsSql);
			 while($laRow=$this->f_Arreglo($lrTb))
	  	    { 
				
				$this->aaDetalle[$this->aiContador][0]=$laRow["cedula_docente"];				
				$this->aaDetalle[$this->aiContador][1]=$laRow["codmat"];
				$this->aaDetalle[$this->aiContador][2]=$laRow["tope"];
				
				$this->aiContador++;  
		    }         
		    $this->f_Cierra($lrTb);
			$this->f_Des();
			$this->aiContador=0;
		    return $lbEnc;
        }
        			
	
		public function fIncluir()
		{   
			$lbEnc=false;
			$this->aaDetalle=$_SESSION["detalle"];
			unset($_SESSION["detalle"]);
			$lbHecho=false;
			$lsSql="select pla.idplanificacion from planificacion_sec as pla
  		    where (pla.codesp='$this->ascodesp')
		    and (pla.peraca='$this->asperaca')
  		    and (pla.regimen='$this->asregimen')
		    and (pla.semestre='$this->assemestre')
		    and (pla.seccion='$this->asseccion')";
		    $this->f_Con();
			$lrTb=$this->f_Filtro($lsSql);
			if($laRow=$this->f_Arreglo($lrTb))
			{
				$lbEnc=true;
			} 
			if(!$lbEnc){
				$this->f_Con();
				$this->f_Begin();
				$lsSql="insert into planificacion_sec (idplanificacion,fechapla,horapla,peraca,codesp,semestre,seccion,regimen)values($this->aiNumero,'$this->asfechapla','$this->ashorapla','$this->asperaca','$this->ascodesp','$this->assemestre','$this->asseccion','$this->asregimen')";
				$lbHecho=$this->f_Ejecutar($lsSql);
				if ($lbHecho)
				{
					for ($lnI=0;$lnI<count($this->aaDetalle);$lnI++)
					 {
						if (($this->aaDetalle[$lnI][0]!="-")&&($this->aaDetalle[$lnI][0]!=""))
						{
						   $lsSql="insert into detalle_plani (idplanificacion,cedula_docente,codmat,tope) values ($this->aiNumero,'".$this->aaDetalle[$lnI][0]."','".$this->aaDetalle[$lnI][1]."','".$this->aaDetalle[$lnI][2]."')";
						   $lbHecho2=$this->f_Ejecutar($lsSql);
						  
						   if (!$lbHecho2)
						   {
							   $lbHecho=false;
						   }
						}
					 }
				}
				if ($lbHecho)
				{
				  $this->f_Commit();
				}
				else
				{
				   $this->f_RollBack();
				}
				
			}
			$this->f_Des();
				if (($lbHecho==true)&&($lbEnc==false)){
					$liHecho=1;
		 		}else if (($lbHecho==false)&&($lbEnc==true)){
					$liHecho=2;
				}else if (($lbHecho==false)&&($lbEnc==false)){
					$liHecho=3;
				}
      	    return $liHecho;
			}
 
       public function fModificar()
       {
	        $this->aaDetalle=$_SESSION["detalle"];
			unset($_SESSION["detalle"]);
	 		$lbHecho=false;
			$this->f_Con();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
			$this->f_Begin();
			$lsSql="update planificacion_sec set fechapla='$this->asfechapla',horapla='$this->ashorapla',peraca='$this->asperaca',codesp='$this->ascodesp',semestre='$this->assemestre',seccion='$this->asseccion',regimen='$this->asregimen'where (idplanificacion=$this->aiNumero)";
			$lbHecho=$this->f_Ejecutar($lsSql);
			if ($lbHecho)
			{
				$lsSql="delete from detalle_plani where (idplanificacion=$this->aiNumero)";
				$lbHecho=$this->f_Ejecutar($lsSql);
				if ($lbHecho)
			    {
					for ($lnI=0;$lnI<$this->aiFilas;$lnI++)
					 {
						if (($this->aaDetalle[$lnI][0]!="-")&&($this->aaDetalle[$lnI][0]!=""))
						{
						   $lsSql="insert into detalle_plani (idplanificacion,cedula_docente,codmat,tope) values ($this->aiNumero,'".$this->aaDetalle[$lnI][0]."','".$this->aaDetalle[$lnI][1]."','".$this->aaDetalle[$lnI][2]."')";
						   $lbHecho2=$this->f_Ejecutar($lsSql);
						   if (!$lbHecho2)
						   {
							   $lbHecho=false;
						   }
						}
					 }
				 }
		    }
		    if ($lbHecho)
      	    {
      	       $this->f_Commit();
		    }
      	    else
      	    {
      	       $this->f_RollBack();
		    }
			$this->f_Des();
			return $lbHecho;
		}
		
		public function fEliminar()
		{
			$lbHecho=false;
			$lsSql="delete from detalle_plani where (idplanificacion=$this->aiNumero)";
			$this->f_Con();
			$lbHecho=$this->f_Ejecutar($lsSql);
			if ($lbHecho)
			{
				$lsSql="delete from planificacion_sec where (idplanificacion=$this->aiNumero)";
				$lbHecho=$this->f_Ejecutar($lsSql);
			}
			if ($lbHecho)
      	    {
      	       $this->f_Commit();
		    }
      	    else
      	    {
      	       $this->f_RollBack();
		    }
			$this->f_Des();
			return $lbHecho;
		}
		
		public function fNuevo()
		{
		    $lsSql="select max(idplanificacion) as mayor from planificacion_sec";
		    $this->f_Con();
			$lrTb=$this->f_Filtro($lsSql);
			if($laRow=$this->f_Arreglo($lrTb))
			{
				  $liAux=$laRow["mayor"]+1;
			}
			$this->f_Cierra($lrTb);
			$this->f_Des();
			return $liAux;
		}
	}			
?>
